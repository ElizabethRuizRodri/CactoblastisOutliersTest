##-----------------------------------------##
##  Structure and diveristy basic analysis ##
##-----------------------------------------##

#Load packages in R:

library(adegenet)
library(hierfstat)
library(fsthet)
library(rgdal)
library(maps)
library(vcfR)

#Charge vcf file clean
Cacto.vcf <- read.vcfR("Cacto_argen_limpio.recode.vcf")

#Convert the vcf object to a genind object
Cacto.ind<- vcfR2genind(Cacto.vcf)
Cacto.ind

#Add populations, charge the table with populations
IndCacto_labels<-read.table("Argen_pop.txt", header=F)

#Insert populations to the genind object
pop(Cacto.ind) <- IndCacto_labels$V2

#Cargamos la tabla de localidades
LocsCacto<- read.table("Argen_locs.txt", sep="\t", header=T)

#Poner las claves al objeto ind
popNames(Cacto.ind)<-LocsCacto$key

#Convertir el objeto genind a hierfstat y genpop para hacer estadísticos
Cacto.fstat <-genind2hierfstat(Cacto.ind)
Cacto.genpop <-genind2genpop(Cacto.ind)

#Realizamos las estadísticas básicas
BasicSS <- basic.stats(Cacto.fstat)

#Calculamos la diversidad para toda la muestra
BasicSS$overall

#Calculamos la heterocigosis promedio, observada y esperada
*Heterocigosis esperada*
Div_Raw.Hs <-as.data.frame(BasicSS$Hs)
*Heterocigosis observada*
Div_Raw.Ho <-as.data.frame(BasicSS$Ho)

#Creamos las gráficas de heterocigosis juntas
par(mfrow=c(1,2))
barplot(colMeans(Div_Raw.Hs,na.rm=T),las=2,main="HE")
barplot(colMeans(Div_Raw.Ho,na.rm=T),las=2,main="HO")

#Obtenemos la tabla con la heterocigosis por localidad
*Heterocigosis esperada (Hs)*
colMeans(BasicSS$Hs, na.rm=TRUE)
Hs<-as.data.frame(colMeans(BasicSS$Hs, na.rm=TRUE))
write.table(Hs,file="HS_argen",row.names=F, col.names=F, quote=F)
*Heterocigosis observada (Ho)*
colMeans(BasicSS$Ho, na.rm=TRUE)
Ho<-as.data.frame(colMeans(BasicSS$Ho, na.rm=TRUE))
write.table(Ho,file="HO_argen",row.names=T, col.names=F, quote=F)

#PCA(individuos)*Hay que hacer este paso para poder calcular la distancia pareada entre individuos
Cacto.scaled <- scaleGen(Cacto.ind, NA.method="mean")
Cacto.pca <- dudi.pca(Cacto.scaled)
#Le ponemos "2" al número de componentes
s.label(Cacto.pca$li)
summary(Cacto.pca)

#Distancia pareada entre individuos y gráfica
hclust(dist(Cacto.pca$li),method="ward.D2")
plot(hclust(dist(Cacto.pca$li),method="ward.D2"),cex=0.5)

###FST
Cacto.fst <- pairwise.neifst(Cacto.fstat)
library(corrplot)
corrplot(as.matrix(Cacto.fst), is.corr=FALSE, type="lower", method="color", COL1(sequential="Purples"))

NOTA: para corregir los valores negativos que salen por tamaño de muestra no homogeneo, se ponen en 0 de la siguiente manera:
Cacto.fst[Cacto.fst<0]<-0



